---
apiVersion: v1
kind: ConfigMap
metadata:
  name: frigate
  labels:
    app: frigate
data:
  config.yml: |
    mqtt:
      host: mqtt
      port: 1883
      user: mqtt
      password: "{FRIGATE_MQTT_PASSWORD}"
    tls:
      enabled: False
    auth:
      enabled: False
    proxy:
      header_map:
        user: X-authentik-username
    logger:
      default: info
      # logs:
      #   frigate.app: debug
      #   frigate.mqtt: debug
      #   frigate.object_detection: debug
      #   detector.ov: debug
      #   watchdog.hikvision-1: debug
      #   ffmpeg.hikvision-1.detect: debug
    # model:
    #   width: 300
    #   height: 300
    #   input_tensor: nhwc
    #   input_pixel_format: bgr
    #   path: /openvino-model/ssdlite_mobilenet_v2.xml
    #   labelmap_path: /openvino-model/coco_91cl_bkgr.txt
    detectors:
      # ov:
      #   type: openvino
      #   device: GPU
      coral1:
        type: edgetpu
        device: pci
    detect:
      enabled: True
      width: 1280
      height: 720
      fps: 5
    objects:
      track:
      - person
      - car
      - motorcycle
      - bicycle
    record:
      enabled: True
      retain:
        days: 7
        mode: motion
      events:
        retain:
          default: 7
          mode: active_objects
          objects:
            person: 30
    ffmpeg:
      hwaccel_args: preset-vaapi
      output_args:
        record: preset-record-generic-audio-copy
    go2rtc:
      streams:
        hikvision-1:
        - rtsp://admin:{FRIGATE_HIKVISION_PASSWORD}@y.y.y.y
        hikvision-2:
        - rtsp://admin:{FRIGATE_HIKVISION_PASSWORD}@y.y.y.y
        hikvision-3:
        - rtsp://admin:{FRIGATE_HIKVISION_PASSWORD}@y.y.y.y
        hikvision-4:
        - rtsp://admin:{FRIGATE_HIKVISION_PASSWORD}@y.y.y.y
        hikvision-5:
        - rtsp://admin:{FRIGATE_HIKVISION_PASSWORD}@y.y.y.y
        hikvision-6:
        - rtsp://admin:{FRIGATE_HIKVISION_PASSWORD}@y.y.y.y
        hikvision-7:
        - rtsp://admin:{FRIGATE_HIKVISION_PASSWORD}@y.y.y.y
        hikvision-8:
        - rtsp://admin:{FRIGATE_HIKVISION_PASSWORD}@y.y.y.y
        pollo-1:
        - rtsp://admin:{FRIGATE_POLLO_PASSWORD}@y.y.y.y
        - "ffmpeg:pollo-1#audio=aac"
      webrtc:
        candidates:
        - y.y.y.y
        - stun:18555
    cameras:
      # Define at least one camera
      hikvision-1:
        ffmpeg:
          inputs:
          - path: rtsp://127.0.0.1:8554/hikvision-1
            roles:
            - record
          - path: rtsp://admin:{FRIGATE_HIKVISION_PASSWORD}@y.y.y.y
            roles:
            - detect
        motion:
          mask:
          - 0.183,0,0.291,0,0.291,0.049,0.185,0.044
      hikvision-2:
        ffmpeg:
          inputs:
          - path: rtsp://127.0.0.1:8554/hikvision-2
            roles:
            - record
          - path: rtsp://admin:{FRIGATE_HIKVISION_PASSWORD}@y.y.y.y
            roles:
            - detect
        motion:
          mask:
          - 1,0.316,0.523,0.084,0.182,0.13,0,0.172,0,0,1,0
        objects:
          track:
          - person
          filters:
            person:
              mask:
              - 1,0.316,0.523,0.084,0.182,0.13,0,0.172,0,0,1,0
              - 0.7,0.815,0.692,0.904,0.716,0.908,0.723,0.823
      hikvision-3:
        ffmpeg:
          inputs:
          - path: rtsp://127.0.0.1:8554/hikvision-3
            roles:
            - record
          - path: rtsp://admin:{FRIGATE_HIKVISION_PASSWORD}@y.y.y.y
            roles:
            - detect
        objects:
          track:
          - person
        motion:
          mask:
          - 0.259,0.029,0.287,0.029,0.287,0.071,0.257,0.069
      hikvision-4:
        ffmpeg:
          inputs:
          - path: rtsp://127.0.0.1:8554/hikvision-4
            roles:
            - record
          - path: rtsp://admin:{FRIGATE_HIKVISION_PASSWORD}@y.y.y.y
            roles:
            - detect
        motion:
          mask:
          - 0.254,0.024,0.293,0.024,0.293,0.071,0.254,0.071
        objects:
          track:
          - person
          - motorcycle
          - bicycle
          filters:
            person:
              mask:
              - 0.381,0.979,0.374,0.809,0.444,0.75,0.487,0.776,0.465,0.825,0.473,0.911,0.45,0.959
      hikvision-5:
        ffmpeg:
          inputs:
          - path: rtsp://127.0.0.1:8554/hikvision-5
            roles:
            - record
          - path: rtsp://admin:{FRIGATE_HIKVISION_PASSWORD}@y.y.y.y
            roles:
            - detect
        motion:
          mask:
          - 1,0,1,0.097,0.487,0.138,0,0.251,0,0
        review:
          alerts:
            required_zones:
              - inner_yard
          detections:
            required_zones:
              - inner_yard
        zones:
          inner_yard:
            coordinates: 0,0.25,0,1,1,1,0.998,0.087,0.878,0.098,0.483,0.125
      hikvision-6:
        ffmpeg:
          inputs:
          - path: rtsp://127.0.0.1:8554/hikvision-6
            roles:
            - record
          - path: rtsp://admin:{FRIGATE_HIKVISION_PASSWORD}@y.y.y.y
            roles:
            - detect
        motion:
          mask:
          - 0.257,0.029,0.287,0.029,0.289,0.069,0.265,0.075
        objects:
          track:
          - person
      hikvision-7:
        ffmpeg:
          inputs:
          - path: rtsp://127.0.0.1:8554/hikvision-7
            roles:
            - record
          - path: rtsp://admin:{FRIGATE_HIKVISION_PASSWORD}@y.y.y.y
            roles:
            - detect
        motion:
          mask:
          - 0.22,0,0.292,0,0.295,0.039,0.221,0.046
        review:
          alerts:
            required_zones:
              - outer_garage
              - entire_garage
          detections:
            required_zones:
              - outer_garage
              - entire_garage
        zones:
          entire_garage:
            coordinates: 0,1,1,1,1,0,0,0
            objects:
              - person
              - motorcycle
              - bicycle
          outer_garage:
            coordinates: 0,0.412,0,0,1,0,1,1,0.766,1,0.797,0.43,0.588,0.344,0.504,0.492,0.285,0.346
            objects:
              - car
      hikvision-8:
        ffmpeg:
          inputs:
          - path: rtsp://127.0.0.1:8554/hikvision-8
            roles:
            - record
          - path: rtsp://admin:{FRIGATE_HIKVISION_PASSWORD}@y.y.y.y
            roles:
            - detect
        objects:
          track:
          - person
        motion:
          mask:
          - 0.291,0.072,0.288,0,0.22,0,0.217,0.073
      pollo-1:
        ffmpeg:
          inputs:
          - path: rtsp://127.0.0.1:8554/pollo-1
            roles:
            - record
          - path: rtsp://admin:{FRIGATE_POLLO_PASSWORD}@y.y.y.y
            roles:
            - detect
        detect:
          width: 640
          height: 360
        objects:
          track:
          - person
        motion:
          mask:
          - 0.761,0,0.747,0.175,0.631,0.114,0.436,0.153,0.441,0
          - 0.199,0,0.27,0,0.267,0.089,0.2,0.088
---
apiVersion: v1
kind: Service
metadata:
  name: frigate
  labels:
    app: frigate
spec:
  type: ClusterIP
  ports:
    - name: http
      port: 5000
      protocol: TCP
      targetPort: http
    - name: auth
      port: 8971
      protocol: TCP
      targetPort: auth
  selector:
    app: frigate
---
apiVersion: v1
kind: Service
metadata:
  name: frigate-webrtc
  labels:
    app: frigate
  annotations:
    kube-vip.io/loadbalancerIPs: y.y.y.y
spec:
  type: LoadBalancer
  externalTrafficPolicy: Local
  ports:
    - name: webrtc-tcp
      port: 8555
      protocol: TCP
      targetPort: webrtc-tcp
    - name: webrtc-udp
      port: 8555
      protocol: UDP
      targetPort: webrtc-udp
  selector:
    app: frigate
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: frigate
  labels:
    app: frigate
spec:
  replicas: 1
  strategy:
    type: Recreate
  selector:
    matchLabels:
      app: frigate
  template:
    metadata:
      labels:
        app: frigate
    spec:
      containers:
      - name: frigate
        image: "ghcr.io/blakeblackshear/frigate:0.14.1"
        imagePullPolicy: IfNotPresent
        ports:
        - name: http
          containerPort: 5000
          protocol: TCP
        - name: webrtc-tcp
          containerPort: 8555
          protocol: TCP
        - name: webrtc-udp
          containerPort: 8555
          protocol: UDP
        - name: auth
          containerPort: 8971
          protocol: TCP
        startupProbe:
          failureThreshold: 20
          httpGet:
            path: /api/version
            port: http
            scheme: HTTP
        livenessProbe:
          httpGet:
            path: /api/version
            port: http
            scheme: HTTP
        readinessProbe:
          httpGet:
            path: /api/version
            port: http
            scheme: HTTP
        env:
        - name: LIBVA_DRIVER_NAME
          value: i965
        envFrom:
        - secretRef:
            name: frigate
        volumeMounts:
          - name: config
            mountPath: /config/config.yml
            subPath: config.yml
          - name: media
            mountPath: /config
            subPath: config
          - name: media
            mountPath: /media/frigate
          - name: recordings
            mountPath: /media/frigate/recordings
          - name: clips
            mountPath: /media/frigate/clips
          - name: exports
            mountPath: /media/frigate/exports
          - name: dshm
            mountPath: /dev/shm
          - name: dshm
            mountPath: /tmp/cache
            subPath: tmp
        resources:
          requests:
            cpu: "1.5"
            memory: "7Gi"
            smarter-devices/dri_card0: 1
            smarter-devices/dri_renderD128: 1
            smarter-devices/apex_0: 1
          limits:
            memory: "10Gi"
            smarter-devices/dri_card0: 1
            smarter-devices/dri_renderD128: 1
            smarter-devices/apex_0: 1
        securityContext:
          capabilities:
            add: ["SYS_ADMIN", "CAP_PERFMON"]
      volumes:
      - name: config
        configMap:
          name: frigate
      - name: media
        hostPath:
          path: /home/ha/frigate
          type: Directory
      - name: recordings
        hostPath:
          path: /mnt/external/backups/recordings
          type: Directory
      - name: clips
        hostPath:
          path: /mnt/external/backups/clips
          type: Directory
      - name: exports
        hostPath:
          path: /mnt/external/backups/exports
          type: Directory
      - name: dshm
        emptyDir:
          medium: Memory
          sizeLimit: 1.5Gi
      nodeSelector:
        kubernetes.io/hostname: node2
---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: frigate
  labels:
    app: frigate
  annotations:
    kubernetes.io/ingress.class: "nginx"
    nginx.ingress.kubernetes.io/auth-url: http://authentik-server.authentik.svc.cluster.local/outpost.goauthentik.io/auth/nginx
    nginx.ingress.kubernetes.io/auth-signin: https://authentik.home.com/outpost.goauthentik.io/start?rd=https://$host$escaped_request_uri
    nginx.ingress.kubernetes.io/auth-response-headers: Set-Cookie,X-authentik-username,X-authentik-groups,X-authentik-email,X-authentik-name,X-authentik-uid
    nginx.ingress.kubernetes.io/auth-snippet: |
        proxy_set_header X-Forwarded-Host $http_host;
    nginx.ingress.kubernetes.io/auth-cache-key: $cookie_authentik_proxy_EhWySFtO
    nginx.ingress.kubernetes.io/auth-cache-duration: 200 202 10m, 401 5s
    gethomepage.dev/description: NVR
    gethomepage.dev/enabled: "true"
    gethomepage.dev/group: Home Automation
    gethomepage.dev/icon: frigate-light.png
    gethomepage.dev/name: Frigate
    gethomepage.dev/pod-selector: app=frigate
    gethomepage.dev/weight: "0"
    gethomepage.dev/widget.type: frigate
    gethomepage.dev/widget.url: http://frigate.ha.svc:5000
    gethomepage.dev/widget.enableRecentEvents: "true"
spec:
  tls:
  - hosts:
    - frigate.home.com
  rules:
  - host: frigate.home.com
    http:
      paths:
        - path: /
          pathType: "ImplementationSpecific"
          backend:
            service:
              name: frigate
              port:
                name: auth
