---
apiVersion: v1
kind: Namespace
metadata:
  name: authentik
---
apiVersion: postgresql.cnpg.io/v1
kind: Cluster
metadata:
  name: authentik-pgsql
  namespace: authentik
spec:
  instances: 2
  bootstrap:
    initdb:
      database: authentik
  postgresql:
    parameters:
      max_wal_size: 2GB
      "pgaudit.log": "all, -misc"
      "pgaudit.log_catalog": "off"
      "pgaudit.log_parameter": "on"
      "pgaudit.log_relation": "on"
  storage:
    size: 1Gi
    storageClass: local-path
  backup:
    retentionPolicy: "7d"
    barmanObjectStore:
      destinationPath: s3://authentik-postgres-backup/
      endpointURL: https://s3.home.com
      s3Credentials:
        accessKeyId:
          name: authentik-pgsql-s3
          key: ACCESS_KEY_ID
        secretAccessKey:
          name: authentik-pgsql-s3
          key: ACCESS_SECRET_KEY
      wal:
        compression: gzip
---
apiVersion: postgresql.cnpg.io/v1
kind: ScheduledBackup
metadata:
  name: authentik-pgsql
  namespace: authentik
spec:
  schedule: "0 0 0 * * *"
  backupOwnerReference: self
  cluster:
    name: authentik-pgsql
