# yum install -y https://repo.radeon.com/amdgpu-install/latest/el/10/amdgpu-install-7.0.2.70002-1.el10.noarch.rpm
# yum clean all
# yum install -y "kernel-headers" "kernel-devel" "kernel-devel-matched"
# yum install -y amdgpu-dkms
# sed -i 's/$amdgpudistro/9.6/g' /etc/yum.repos.d/amdgpu.repo /etc/yum.repos.d/amdgpu-proprietary.repo /etc/yum.repos.d/rocm.repo
# amdgpu-install -y --accept-eula --vulkan=radv
# yum install -y mesa-amdgpu-va-drivers
# Alt
# yum install -y amd-gpu-firmware mesa-dri-drivers mesa-vulkan-drivers
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: sunshine
  labels:
    app: sunshine
data:
  # https://github.com/linuxhw/EDID/blob/master/Digital/Vizio/VIZ2001/D9D8EB0DA5AD
  edid.txt: |-
    00 ff ff ff ff ff ff 00 59 3a 01 20 01 01 01 01 02 1a 01 03 80 59 32 78 0a e8 9d a3 54 51 97 26 0f 47 4a 2d 0e 00 01 00 01 00 01 00 01 00 01 00 01 01 01 01 01 01 02 3a 80 18 71 38 2d 40 58 2c 45 00 75 f2 31 00 00 1e 00 00 00 fd 00 32 4d 1f 46 0f 00 0a 20 20 20 20 20 20 00 00 00 ff 00 55 53 54 58 41 52 30 31 30 30 30 30 31 00 00 00 fc 00 45 34 30 2d 44 30 0a 20 20 20 20 20 20 01 c5 02 03 25 71 4a 01 06 07 02 03 05 90 04 20 22 29 09 07 07 15 07 50 57 07 01 83 01 00 00 67 03 0c 00 20 00 38 2d 02 3a 80 18 71 38 2d 40 58 2c 45 00 75 f2 31 00 00 1e 01 1d 00 72 51 d0 1e 20 6e 28 55 00 75 f2 31 00 00 1e 8c 0a a0 14 51 f0 16 00 26 7c 43 00 75 f2 31 00 00 98 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 f4
  xorg.dummy.conf: |
    Section "Device"
        Identifier  "AMD GPU"
        Driver      "amdgpu"
        Option      "DRI" "3"
        Option      "TearFree" "true"
        Option      "VirtualHeads" "0"
        Option      "SWcursor" "true"
        Option      "CustomEDID" "DisplayPort-0:/etc/X11/edid/edid.bin"
        Option      "IgnoreEDID" "false"
    EndSection

    Section "Monitor"
        Identifier   "FakeMonitor"
        HorizSync    30.0 - 83.0
        VertRefresh  56.0 - 75.0
        Option       "PreferredMode" "1920x1080"
        Option       "Enable" "true"
        Option       "Primary" "true"
    EndSection

    Section "Screen"
        Identifier     "Default Screen"
        Device         "AMD GPU"
        Monitor        "FakeMonitor"
        DefaultDepth   24
        SubSection "Display"
            Depth     24
            Modes     "1920x1080"
        EndSubSection
    EndSection

    Section "ServerLayout"
        Identifier     "Layout0"
        Screen         0 "Default Screen"
    EndSection
---
apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app: sunshine
  name: sunshine
spec:
  replicas: 1
  selector:
    matchLabels:
      app: sunshine
  strategy:
    type: Recreate
  template:
    metadata:
      labels:
        app: sunshine
      annotations:
        k8s.v1.cni.cncf.io/networks: '[{ "name" : "macvlan-conf", "namespace": "kube-system", "interface": "macvlan0", "ips": [ "y.y.y.y
    spec:
      enableServiceLinks: false
      securityContext:
        fsGroup: 1001
      initContainers:
      - name: max-map-count-setter
        image: busybox:1.28
        command: ['sysctl', '-w', 'vm.max_map_count=524288']
        securityContext:
          privileged: true
      - image: docker:28.5.1-dind
        name: docker
        securityContext:
          privileged: true
        volumeMounts:
        - name: docker
          mountPath: /var/run/
        startupProbe:
          exec:
            command:
            - /usr/bin/test
            - -S
            - /var/run/docker.sock
        livenessProbe:
          exec:
            command:
            - /usr/bin/test
            - -S
            - /var/run/docker.sock
        restartPolicy: Always
      containers:
      - image: ghcr.io/thisisqasim/steam-headless:fedora@sha256:9eebb7b0ef8c91ca262375030e1d858b7f894436b515aadee1797a2fe503710d
        name: server
        securityContext:
          seccompProfile:
            type: Unconfined
          appArmorProfile:
            type: Unconfined
          capabilities:
            add:
            - SYS_ADMIN
            - SYS_NICE
            - SYS_PTRACE
            - NET_ADMIN
            - NET_RAW
            - MKNOD
            - SETUID
            - CAP_SYS_TTY_CONFIG
        command:
        - /bin/bash
        - -c
        - |
          curl -LO https://download.docker.com/linux/static/stable/x86_64/docker-28.5.1.tgz
          tar xzvf docker-28.5.1.tgz
          sudo cp docker/* /usr/bin/
          ulimit -n 1048576
          exec /entrypoint.sh
        env:
        - name: DISPLAY
          value: :55
        - name: USER_LOCALES
          value: 'en_US.UTF-8 UTF-8'
        - name: PUID
          value: "1001"
        - name: PGID
          value: "1001"
        - name: UMASK
          value: '000'
        - name: TZ
          value: "Asia/Karachi"
        - name: SHM_SIZE
          value: '2G'
        - name: MODE
          value: 'primary'
        - name: WEB_UI_MODE
          value: 'vnc'
        - name: ENABLE_VNC_AUDIO
          value: 'false'
        - name: PORT_NOVNC_WEB
          value: '8083'
        - name: NEKO_NAT1TO1
          value: ''
        - name: ENABLE_SUNSHINE
          value: 'true'
        - name: ENABLE_EVDEV_INPUTS
          value: 'true'
        - name: STEAM_ARGS
          value: '-silent -eula=yes'
        - name: FORCE_X11_DUMMY_CONFIG
          value: 'true'
        - name: ENABLE_SID
          value: 'false'
        # - name: INSTALL_EXTRAS
        #   value: '1' # installs additional dependencies, including VC++ Redist
        envFrom:
        - secretRef:
            name: sunshine
        ports:
        - name: http
          containerPort: 47990
          protocol: TCP
        startupProbe:
          exec:
            command:
            - /usr/sbin/test
            - -S
            - /tmp/.X11-unix/X55
          failureThreshold: 600
          periodSeconds: 5
        readinessProbe:
          exec:
            command:
            - /usr/sbin/test
            - -S
            - /tmp/.X11-unix/X55
          initialDelaySeconds: 15
          periodSeconds: 5
        resources:
          requests:
            smarter-devices/uinput: 1
            smarter-devices/dri_card0: 1
            smarter-devices/dri_renderD128: 1
          limits:
            smarter-devices/uinput: 1
            smarter-devices/dri_card0: 1
            smarter-devices/dri_renderD128: 1
        volumeMounts:
        - mountPath: /home/default/Games/
          name: external
          subPath: games
        - mountPath: /mnt/games/
          name: external
          subPath: games 
        - mountPath: /mnt/external/
          name: external
        - mountPath: /home/default/
          name: home
          subPath: home
        - mountPath: /templates/xorg/xorg.dummy.conf
          name: config
          subPath: xorg.dummy.conf
        - mountPath: /etc/X11/edid/edid.bin
          name: config
          subPath: edid.txt
        - mountPath: /dev/shm
          name: dshm
        - mountPath: /tmp/.X11-unix/
          name: x11-socket
        - mountPath: /tmp/pulse/
          name: pulse-socket
        - name: docker
          mountPath: /var/run/docker.sock
          subPath: docker.sock
        - mountPath: /dev
          name: dev
        - mountPath: /run/udev
          name: udev
      volumes:
      - name: home
        hostPath:
          path: /home/entertainment/sunshine/
          type: Directory
      - name: external
        hostPath:
          path: /mnt/external
          type: Directory
      - name: config
        configMap:
          name: sunshine
      - name: dshm
        emptyDir:
          medium: Memory
          sizeLimit: 2Gi
      - name: x11-socket
        emptyDir: {}
      - name: pulse-socket
        emptyDir: {}
      - name: docker
        emptyDir: {}
      - name: dev
        hostPath:
          path: /dev
      - name: udev
        hostPath:
          path: /run/udev
      nodeSelector:
        kubernetes.io/hostname: node3
---
apiVersion: v1
kind: Service
metadata:
  name: sunshine
  labels:
    app: sunshine
spec:
  ports:
  - port: 47990
    protocol: TCP
    targetPort: http
  selector:
    app: sunshine
  type: ClusterIP
---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: sunshine
  labels:
    app: sunshine
  annotations:
    kubernetes.io/ingress.class: "nginx"
    nginx.ingress.kubernetes.io/backend-protocol: HTTPS
    gethomepage.dev/description: Game Streaming
    gethomepage.dev/enabled: "true"
    gethomepage.dev/group: Entertainment
    gethomepage.dev/icon: sunshine.png
    gethomepage.dev/name: sunshine
    gethomepage.dev/pod-selector: app=sunshine
spec:
  tls:
  - hosts:
    - sunshine.home.com
  rules:
  - host: sunshine.home.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: sunshine
            port:
              number: 47990
